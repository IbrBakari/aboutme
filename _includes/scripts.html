<script>
  const ORCID_ID = '0000-0002-7173-0727';

  // Mise √† jour automatique de l'ann√©e dans le footer
  const yearEl = document.getElementById('year');
  if (yearEl) yearEl.textContent = new Date().getFullYear();

  // Gestion du th√®me clair/sombre
  const themeBtn = document.getElementById('themeBtn');
  const rootEl = document.documentElement;
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme) {
    rootEl.setAttribute('data-theme', savedTheme);
  } else {
    rootEl.setAttribute('data-theme', 'light');
  }
  if (themeBtn) {
    themeBtn.addEventListener('click', () => {
      const curr = rootEl.getAttribute('data-theme') || 'light';
      const next = curr === 'light' ? 'dark' : 'light';
      rootEl.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      themeBtn.textContent = 'üåì Th√®me';
    });
  }

  // --- Menu mobile ---
  const menuBtn = document.getElementById('menuBtn');
  const navLinks = document.getElementById('navLinks');

  if (menuBtn && navLinks) {
    menuBtn.addEventListener('click', () => {
      const open = navLinks.classList.toggle('open');
      menuBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
      menuBtn.setAttribute('aria-label', open ? 'Fermer le menu' : 'Ouvrir le menu');
    });
    // fermer au clic ext√©rieur
    document.addEventListener('click', (e) => {
      if (!navLinks.classList.contains('open')) return;
      const within = navLinks.contains(e.target) || menuBtn.contains(e.target);
      if (!within) {
        navLinks.classList.remove('open');
        menuBtn.setAttribute('aria-expanded','false');
      }
    });
  }

  // Notifications (toasts)
  function toast(msg) {
    const t = document.createElement('div');
    t.textContent = msg;
    Object.assign(t.style, {
      position: 'fixed',
      left: '50%',
      bottom: '24px',
      transform: 'translateX(-50%)',
      background: 'linear-gradient(135deg,var(--accent),var(--accent2))',
      color: '#fff',
      padding: '12px 16px',
      borderRadius: '10px',
      boxShadow: '0 10px 30px rgba(0,0,0,.2)',
      zIndex: 1000,
      fontWeight: 700
    });
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 2400);
  }

  // Publications ORCID
  const pubList = document.getElementById('pubList');
  const pubCount = document.getElementById('pubCount');

  async function loadPublications() {
    const endpoint = `https://pub.orcid.org/v3.0/${ORCID_ID}/works`;
    try {
      const res = await fetch(endpoint, {
        headers: { 'Accept': 'application/vnd.orcid+json' },
        cache: 'no-store'
      });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      const items = (data['group'] || []).map(g => {
        const work = g['work-summary']?.[0];
        const title = work?.title?.title?.value || 'Sans titre';
        const year = work?.['publication-date']?.year?.value || '';
        const journal = work?.['journal-title']?.value || '';
        const url = work?.url?.value || extractDOI(g) || '#';
        return { title, year, journal, url };
      }).sort((a, b) => (b.year || 0) - (a.year || 0));
      renderPublications(items);
    } catch (e) {
      try {
        const res2 = await fetch('{{ site.baseurl }}/publications.json', { cache: 'no-store' });
        if (!res2.ok) throw new Error('HTTP ' + res2.status);
        const items2 = await res2.json();
        renderPublications(items2);
      } catch (e2) {
        if (pubList) pubList.innerHTML = '<div class="note">Impossible de charger les publications.</div>';
      }
    }
  }

  function extractDOI(group) {
    try {
      const ext = group['external-ids']['external-id'] || [];
      const doi = ext.find(x => (x['external-id-type'] || '').toLowerCase() === 'doi');
      if (doi) {
        const v = doi['external-id-value'];
        return v ? ('https://doi.org/' + v) : null;
      }
    } catch (_) { return null; }
    return null;
  }

  function renderPublications(items) {
    if (!items || !items.length) {
      if (pubList) pubList.innerHTML = '<div class="note">Aucune publication trouv√©e pour l‚Äôinstant.</div>';
      return;
    }
    if (pubCount) {
      pubCount.style.display = 'inline-block';
      pubCount.textContent = items.length + ' entr√©es';
    }
    if (pubList) {
      pubList.innerHTML = items.map(p => `
        <div class="pub">
          <div><strong>${escapeHtml(p.title)}</strong></div>
          <div>${p.journal ? escapeHtml(p.journal) + ' ¬∑ ' : ''}${p.year || ''}</div>
          ${p.url && p.url !== '#' ? `<a href="${p.url}" target="_blank" rel="noopener">Lien</a>` : ''}
        </div>`).join('');
    }
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>\"']/g, m => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#039;"
    }[m]));
  }

  document.addEventListener('DOMContentLoaded', loadPublications);


// --- Envoi du formulaire (Formspree) ---
  const contactForm = document.getElementById('contactForm');
  if (contactForm) {
    contactForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const data = new FormData(form);
      try{
        const res = await fetch(form.action, {
          method: form.method,
          body: data,
          headers: { 'Accept':'application/json' }
        });
        if(res.ok){
          toast('‚úÖ Merci, votre message a bien √©t√© envoy√©.');
          form.reset();
        }else{
          toast('‚ùå Oups, une erreur est survenue. R√©essayez.');
        }
      }catch(_){
        toast('‚ùå Impossible de contacter le service. V√©rifiez votre connexion.');
      }
    });
  }


  // --- Exp√©riences ORCID ---
  const empList  = document.getElementById('empList');
  const empCount = document.getElementById('empCount');

  async function loadEmployments(){
    if(!empList) return; // section absente
    try{
      const res = await fetch(`https://pub.orcid.org/v3.0/${ORCID_ID}/employments`, {
        headers: { 'Accept':'application/vnd.orcid+json' },
        cache: 'no-store'
      });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data  = await res.json();
      const items = normalizeEmployments(data);
      if(!items.length) return loadEmploymentsFallback();
      renderEmployments(items);
    }catch(_){
      return loadEmploymentsFallback();
    }
  }
  async function loadEmploymentsFallback(){
    try{
      const res2 = await fetch('{{ site.baseurl }}/employments.json', { cache:'no-store' });
      if(!res2.ok) throw new Error('HTTP '+res2.status);
      const items2 = await res2.json();
      renderEmployments(items2);
    }catch(_){
      empList.innerHTML = '<div class="note">Impossible de charger les exp√©riences (ORCID et fallback indisponibles).</div>';
    }
  }
  function normalizeEmployments(data){
    const summaries =
      data?.employments?.["employment-summary"] ||
      data?.["employment-summary"] ||
      data?.["activities-summary"]?.employments?.["employment-summary"] ||
      [];
    return summaries.map(s => {
      const org   = s?.organization?.name || '';
      const city  = s?.organization?.address?.city || '';
      const country = s?.organization?.address?.country || '';
      const role  = s?.["role-title"] || s?.["department-name"] || '';
      const start = joinDate(s?.["start-date"]);
      const end   = joinDate(s?.["end-date"]);
      return { org, city, country, role, start, end };
    }).filter(e => e.org || e.role);
  }
  function joinDate(d){
    if(!d) return '';
    const y = d?.year?.value || '';
    const m = d?.month?.value || '';
    const dd= d?.day?.value || '';
    return [y,m,dd].filter(Boolean).join('-');
  }
  function esc(s){ return String(s||'').replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
  function renderEmployments(items){
    if(!items.length){ empList.innerHTML = '<div class="note">Aucune exp√©rience trouv√©e.</div>'; return; }
    if(empCount){ empCount.style.display='inline-block'; empCount.textContent = items.length + ' entr√©es'; }
    empList.innerHTML = items.map(e => {
      const loc = [e.city, e.country].filter(Boolean).join(', ');
      const dates = [e.start, e.end].filter(Boolean).join(' ‚Üí ');
      return `<div class="pub">
        <div><strong>${esc(e.role || e.org)}</strong></div>
        <div>${esc(e.org)}${loc ? ' ¬∑ '+esc(loc): ''}${dates ? ' ¬∑ '+esc(dates): ''}</div>
      </div>`;
    }).join('');
  }

  // Appels au chargement (en plus de loadPublications d√©j√† pr√©sent)
  document.addEventListener('DOMContentLoaded', loadEmployments);

</script>

<script src="{{ site.baseurl }}/assets/js/site.js"></script>
